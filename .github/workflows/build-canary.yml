name: Publish Canary

on:
  push:
    branches: [main]
    paths:
      - 'application/**'
      - '.github/workflows/**'
      - '.github/actions/**'

jobs:
  publish-canary-linux:
    name: Build & Publish for Linux (Ubuntu 20.04)
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    # ✅ Usamos Ubuntu 20.04: el balance perfecto entre compatibilidad y modernidad.
    container:
      image: ubuntu:20.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Linux build dependencies
        run: |
          apt-get update && apt-get install -y --no-install-recommends \
            curl \
            git \
            # El paquete de WebKit para Ubuntu 20.04 es la versión 4.1
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf
      
      - name: Setup Environment & Build
        uses: ./.github/actions/setup-and-build
        with:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          GITHUB_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
          

  publish-canary-windows:
    name: Build & Publish for Windows
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Environment & Build
        uses: ./.github/actions/setup-and-build
        with:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          GITHUB_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}